<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Balanční Hra s Fyzikou</title>
    <!-- Tailwind CSS pro rychlé stylování UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js pro 3D grafiku -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Cannon-es pro realistickou fyziku -->
    <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.min.js"></script>
    <style>
        /* Nastavení fontu a těla */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e4e4e7;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Styl pro 3D plátno */
        canvas {
            display: block;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            touch-action: none; /* Zabraňuje výchozímu chování prohlížeče při dotyku */
        }
        /* Herní UI panel */
        #ui-panel {
            pointer-events: none; /* Aby se dotyky propouštěly na canvas */
            text-shadow: 1px 1px 2px #000;
        }
        /* Vizualizace tahu (swipe) */
        #swipe-indicator {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid #5d50c6;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
            transition: all 0.05s linear;
        }
        /* Animace načítání */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }
        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #8e54e9;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">

    <!-- Překrytí pro načítání -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-xl font-bold">Načítání 3D Fyziky...</p>
    </div>

    <!-- Herní UI Panel -->
    <div id="ui-panel" class="absolute top-0 left-0 w-full p-4 flex flex-col items-center z-10">
        <h1 class="text-3xl font-extrabold text-purple-300">3D Fyzika Míče</h1>
        <p id="instruction" class="text-lg mt-2 text-gray-300 bg-black bg-opacity-30 p-2 rounded-lg">
            **TAHEM (Swipe) do 4 směrů** vystřelíš míč.
        </p>
        <div id="score" class="text-2xl mt-4 font-mono text-yellow-300">Skóre: 0</div>
    </div>

    <!-- 3D Canvas se vykreslí sem -->
    <div id="game-container" class="w-full h-full max-w-4xl max-h-[800px] relative">
        <!-- Zde bude plátno Three.js -->
    </div>

    <!-- Indikátor tahu -->
    <div id="swipe-indicator"></div>

    <script>
        // Nastavení globálních proměnných
        let renderer, scene, camera;
        let world, ballBody, groundBody;
        let ballMesh, groundMesh;
        let isTouching = false;
        let startX = 0, startY = 0;
        const swipeIndicator = document.getElementById('swipe-indicator');
        const gameContainer = document.getElementById('game-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const scoreElement = document.getElementById('score');
        let score = 0;

        // Fyzikální konstanty
        const BALL_RADIUS = 0.5;
        const SWIPE_FORCE_MULTIPLIER = 8;
        const CAMERA_DISTANCE = 4;
        const CAMERA_HEIGHT = 2;

        window.onload = function () {
            // Inicializace po načtení okna a skriptů
            initPhysics();
            initThree();
            setupControls();
            loadingOverlay.style.display = 'none';
            animate();
        };

        // --- 1. Inicializace Fyziky (Cannon.js) ---
        function initPhysics() {
            world = new CANNON.World();
            world.gravity.set(0, -9.82, 0); // Standardní gravitace dolů

            // Materiály
            const groundMaterial = new CANNON.Material('groundMaterial');
            const ballMaterial = new CANNON.Material('ballMaterial');
            const contactMaterial = new CANNON.ContactMaterial(
                groundMaterial,
                ballMaterial,
                { friction: 0.4, restitution: 0.8 } // Tření a odrazivost
            );
            world.addContactMaterial(contactMaterial);

            // Těleso pro ZEM (statické)
            const groundShape = new CANNON.Plane();
            groundBody = new CANNON.Body({ mass: 0, material: groundMaterial });
            groundBody.addShape(groundShape);
            groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0); // Otočení, aby ležela
            world.addBody(groundBody);

            // Těleso pro MÍČ (dynamické)
            const ballShape = new CANNON.Sphere(BALL_RADIUS);
            ballBody = new CANNON.Body({ mass: 1, material: ballMaterial });
            ballBody.addShape(ballShape);
            ballBody.position.set(0, BALL_RADIUS + 0.1, 0); // Startovní pozice nad zemí
            world.addBody(ballBody);
        }

        // --- 2. Inicializace 3D Grafiky (Three.js) ---
        function initThree() {
            // Scéna
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x3a2d59); // Tmavě fialové pozadí

            // Kamera
            camera = new THREE.PerspectiveCamera(75, gameContainer.clientWidth / gameContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, CAMERA_HEIGHT, CAMERA_DISTANCE); // Počáteční pozice kamery

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(gameContainer.clientWidth, gameContainer.clientHeight);
            renderer.shadowMap.enabled = true; // Zapnutí stínů
            gameContainer.appendChild(renderer.domElement);

            // Světla
            const ambientLight = new THREE.AmbientLight(0x404040, 5); // Měkké světlo
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);

            // Mesh pro ZEM
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x5d50c6, side: THREE.DoubleSide });
            groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
            groundMesh.rotation.x = -Math.PI / 2;
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);

            // Mesh pro MÍČ
            const ballGeometry = new THREE.SphereGeometry(BALL_RADIUS, 32, 32);
            const ballMaterial = new THREE.MeshPhongMaterial({ color: 0xe9c46a });
            ballMesh = new THREE.Mesh(ballGeometry, ballMaterial);
            ballMesh.castShadow = true;
            scene.add(ballMesh);

            // Handle resize
            window.addEventListener('resize', onWindowResize, false);
            onWindowResize(); // Initial call
        }

        function onWindowResize() {
            if (!gameContainer || !renderer || !camera) return;

            const width = gameContainer.clientWidth;
            const height = gameContainer.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        // --- 3. Ovládání Dotykem a Tahem ---

        function setupControls() {
            renderer.domElement.addEventListener('touchstart', handleTouchStart);
            renderer.domElement.addEventListener('touchmove', handleTouchMove);
            renderer.domElement.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchStart(event) {
            event.preventDefault();
            if (event.touches.length > 0) {
                isTouching = true;
                startX = event.touches[0].clientX;
                startY = event.touches[0].clientY;

                // Zobrazení indikátoru na místě dotyku
                swipeIndicator.style.left = `${startX}px`;
                swipeIndicator.style.top = `${startY}px`;
                swipeIndicator.style.display = 'block';
            }
        }

        function handleTouchMove(event) {
            if (isTouching && event.touches.length > 0) {
                const currentX = event.touches[0].clientX;
                const currentY = event.touches[0].clientY;

                // Posunutí indikátoru tahu (zpětná vazba pro hráče)
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // Omezení délky indikátoru pro vizuální čistotu
                const maxLen = 50;
                const len = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), maxLen);
                const angle = Math.atan2(deltaY, deltaX);

                swipeIndicator.style.width = `${10 + len / 2}px`;
                swipeIndicator.style.height = `${10 + len / 2}px`;
                swipeIndicator.style.transform = `translate(-50%, -50%) translate(${len * Math.cos(angle)}px, ${len * Math.sin(angle)}px)`;
            }
        }

        function handleTouchEnd(event) {
            if (isTouching) {
                const endX = event.changedTouches[0].clientX;
                const endY = event.changedTouches[0].clientY;

                const deltaX = endX - startX;
                const deltaY = endY - startY;

                // Vypočítání síly a směru tahu (Swipe)
                const swipeMagnitude = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const directionX = -deltaX; // Tah doprava = Síla doleva
                const directionZ = -deltaY; // Tah dolů = Síla dopředu (v 3D světě Z-osa)

                // Normalizace a vynásobení konstantou síly
                if (swipeMagnitude > 10) { // Minimální délka tahu pro aktivaci
                    const forceX = (directionX / swipeMagnitude) * SWIPE_FORCE_MULTIPLIER;
                    const forceZ = (directionZ / swipeMagnitude) * SWIPE_FORCE_MULTIPLIER;

                    // Aplikace IMPULSU na střed tělesa míče
                    // Fyzika Cannon.js používá Y pro vertikální osu (nahoru)
                    const impulse = new CANNON.Vec3(forceX, 0, forceZ);
                    const worldPoint = ballBody.position;
                    ballBody.applyImpulse(impulse, worldPoint);

                    score += Math.floor(swipeMagnitude / 5);
                    scoreElement.textContent = `Skóre: ${score}`;
                }

                // Skrytí a reset indikátoru tahu
                swipeIndicator.style.display = 'none';
                swipeIndicator.style.transform = 'translate(-50%, -50%)';
                swipeIndicator.style.width = '10px';
                swipeIndicator.style.height = '10px';
                isTouching = false;
            }
        }


        // --- 4. Hlavní Animační Smyčka ---
        const timeStep = 1 / 60; // Fyzika běží na 60 FPS
        let lastTime = 0;

        function animate(time) {
            requestAnimationFrame(animate);

            if (lastTime !== undefined) {
                const dt = (time - lastTime) / 1000;
                world.step(timeStep, dt); // Posun fyziky
            }
            lastTime = time;

            // 1. Synchronizace 3D grafiky s fyzikou
            ballMesh.position.copy(ballBody.position);
            ballMesh.quaternion.copy(ballBody.quaternion);

            // 2. Pohled první osoby (Kamera sleduje míč)
            const ballPosition = ballMesh.position;
            const targetX = ballPosition.x;
            const targetY = ballPosition.y + CAMERA_HEIGHT - BALL_RADIUS; // Mírně nad míčem
            const targetZ = ballPosition.z + CAMERA_DISTANCE;

            // Hladký pohyb kamery (interpolace)
            camera.position.x += (targetX - camera.position.x) * 0.05;
            camera.position.y += (targetY - camera.position.y) * 0.05;
            camera.position.z += (targetZ - camera.position.z) * 0.05;

            // Kamera se dívá na míč
            camera.lookAt(ballPosition);

            // 3. Vykreslení scény
            renderer.render(scene, camera);

            // 4. Reset, pokud míč spadne pod platformu
            if (ballBody.position.y < -5) {
                resetBall();
            }
        }

        function resetBall() {
            // Zastavení míče a přesun na startovní pozici
            ballBody.velocity.set(0, 0, 0);
            ballBody.angularVelocity.set(0, 0, 0);
            ballBody.position.set(0, BALL_RADIUS + 0.1, 0);
            score = 0;
            scoreElement.textContent = `Skóre: 0`;
        }

    </script>
</body>
</html>

